# General settings
set -g default-terminal "screen-256color"
set -ga terminal-overrides ",xterm-256color:Tc"
set -g focus-events on
set -g history-limit 20000
set -g base-index 1
set -g pane-base-index 1
set -g display-time 2000
set -g status-keys emacs
set-environment -g CHERE_INVOKING 1

# Bindings
unbind C-b
set -g prefix C-a
bind a send-prefix
bind W choose-tree -Z
bind ? list-keys

# Act like vim
set-window-option -g mode-keys vi
unbind %
bind v split-window -h -c "#{pane_current_path}"
bind s split-window -v -c "#{pane_current_path}"
# key bindings for vi-like copy/paste
bind Escape copy-mode
bind -T copy-mode-vi v send -X begin-selection

bind -T copy-mode-vi y "send -X copy-pipe 'wl-copy'"

bind -T copy-mode-vi C-h select-pane -L
bind -T copy-mode-vi C-j select-pane -D
bind -T copy-mode-vi C-k select-pane -U
bind -T copy-mode-vi C-l select-pane -R

# Display pane numbers longer
set -g display-panes-time 2000

# Use wl-paste to load clipboard into tmux paste buffer
bind -N "paste from clipboard primary" \
	C-p run-shell "wl-paste --primary --no-newline | tmux load-buffer - ; tmux paste-buffer"

# Avoid "escape + <key>" behaviour, e.g. in vim, escape to normal mode and move
set escape-time 0
bind -n M-h select-pane -L
bind -n M-j select-pane -D
bind -n M-k select-pane -U
bind -n M-l select-pane -R

bind S set-window-option synchronize-panes
bind A set-window-option monitor-activity
bind 0 select-window -t :10

# open popup pane with fzf to select man page, and open it in pane
bind m {
	run-shell "fd --max-depth 2 --type f --extension gz . $(manpath -g | tr ':' ' ') --exec echo '{/.}' | fzf-tmux -p | tmux loadb -b manpane -"
	splitw -f -h
	setb -b manpane_cmd "man "
	pasteb -b manpane_cmd
	pasteb -b manpane
}

# Split pane with fzf to select password and copy to clipboard
# Manually clear clipboard, since pass background process dies with popup
bind p {
	split-window -v "fd -t f --base-directory ~/.password-store | fzf --reverse | sed 's/\.gpg$//' | xargs pass show --clip"
	run-shell -d 60 -b "wl-copy --clear"
}

# Open new windows in current directory with C, or session default with c
bind C new-window -c "#{pane_current_path}"
bind f run-shell "tmux new-window ~/.dotfiles/scripts/tmux-sessionizer"
bind F choose-tree -s -O time -r -N

# easy resizing of panes
bind -r J resize-pane -D 6
bind -r K resize-pane -U 5
bind -r H resize-pane -L 5
bind -r L resize-pane -R 5

# Enter copy mode on Shift+PageUp to better emulate normal terminal scrolling.
# Allow Shift+PageDown to be used to scroll down for convenience.
bind -n S-PageUp copy-mode -u
bind -n S-PageDown send-keys PageDown

# tmux menu of useful commands

bind-key -T prefix > display-menu -T "#[align=centre]Magic features | #{pane_index} (#{pane_id})" -x P -y P \
"Send ENTER to pane(s) after inactivity" "" "command-prompt -I ssh,300 -p \"pane current command:\",\"Inactivity time(s):\" \"run-shell -b '_tmux_bg_task.py send-key --window #S:#I --enter --pane-cmd %1 --inactivity %2'\"" \
"Stop send-key task for this window" "" "run-shell -b '_tmux_bg_task.py send-key --window #{window_id} --kill'" \
"Stop send-key tasks all windows" "" "run-shell -b '_tmux_bg_task.py send-key --window all --kill'" \
"Reload tmux.conf" r "source-file ~/.tmux.conf \; display-message 'tmux.conf reloaded'" \
"" \
"Set alarm" a "command-prompt -p \"alarm time (30 min; hh:mm):\" \"run-shell -b '~/.dotfiles/scripts/tmux_alarm.sh --set %%'\"" \
"Clear alarm" "" "confirm -p \"clear current alarm?\" \"run-shell '~/.dotfiles/scripts/tmux_alarm.sh --kill '\"" \
"" \
"Find pid in pane (back: C-a ')" f "run-shell '_tmux_find_pane.py --find-pid #{pane_id} -q --mark-pane #{pane_id}'; \
switchc -t \"{marked}\"; \
run-shell '_tmux_find_pane.py -q --mark-buffer-pane'" \
"Go to parent pane of pid" "" "command-prompt -p \"Enter PID:\" \"run-shell '_tmux_find_pane.py --pid %% -q --mark-pane #{pane_id}'; \
switchc -t '{marked}'; \
run-shell '_tmux_find_pane.py -q --mark-buffer-pane'\"" \
"Go to globally last pane" "" "run-shell '_tmux_find_pane.py -q --mark-buffer-pane'; \
switchc -t \"{marked}\"" \
"" \
"join selected pane (vertical)" s "choose-tree -Z \"join-pane -v -s '%%'\"" \
"join selected pane (horizontal)" v "choose-tree -Z \"join-pane -h -s '%%'\"" \
"" \
"Swap Up" u "swap-pane -U" \
"Swap Down" d "swap-pane -D" \
"#{?pane_marked_set,,-}Swap Marked" s swap-pane \
"" \
Kill X kill-pane \
Respawn R "respawn-pane -k" \
"#{?pane_marked,Unmark,Mark}" m "select-pane -m" \
"#{?window_zoomed_flag,Unzoom,Zoom}" z "resize-pane -Z"

bind \' switch-client -t "{marked}"

bind u run-shell "tmux capture-pane -p | ~/.dotfiles/scripts/open_url_stdin.sh"

bind -n f1 selectw -T -t :1
bind -n f2 selectw -T -t :2
bind -n f3 selectw -T -t :3
bind -n f4 selectw -T -t :4
bind -n f5 selectw -T -t :5
bind -n f6 selectw -T -t :6
bind -n f7 selectw -T -t :7
bind -n f8 selectw -T -t :8
bind -n f9 selectw -T -t :9
bind -n f10 selectw -T -t :10
bind -n f11 previous-window
bind -n f12 next-window
bind -n C-Space last-window

# Switch sessions and redraw status bar
bind -n S-f1 switch-client -t $1\; refresh -S
bind -n S-f2 switch-client -t $2\; refresh -S
bind -n S-f3 switch-client -t $3\; refresh -S
bind -n S-f4 switch-client -t $4\; refresh -S
bind -n S-f5 switch-client -t $5\; refresh -S
bind -n S-f6 switch-client -t $6\; refresh -S
bind -n S-f7 switch-client -t $7\; refresh -S
bind -n S-f8 switch-client -t $8\; refresh -S
bind -n S-f9 switch-client -t home\; refresh -S
# last, previous, next sessions
bind -n S-f10 switch-client -l\; refresh -S
bind -n S-f11 switch-client -p\; refresh -S
bind -n S-f12 switch-client -n\; refresh -S

# window title string (uses statusbar variables)
set -g set-titles-string "#T"

setw -g automatic-rename on

# if #{pane_current_command} == ssh in any pane in a window;
# - set window name
# - blue fg color
# if vim runs in the active pane;
# - green fg color of the window name
# if #{pane_current_path} is $HOME;
# - set window name to "~"
# else;
# - set window name to basename of #{pane_current_path}
# debug with: tmux display-message -p -v "FORMAT"

 setw -g automatic-rename-format '#{?#{m:*|ssh|*,#{P:|#{pane_current_command}|}},\
#[fg=blue],#{?#{m/r:vi(mx?)?,#{pane_current_command}},#[fg=green],}#{b:pane_current_path}}'
bind * setw automatic-rename on

set -g status-left "#S "
set -g status-left-length 80
set -g status-right "%H:%M, %a %h %e "


source-file ~/.dotfiles/tmux/powerline-orange.tmuxtheme

# List tmux sessions
set -g status-left-length 60
set -g status-left "#[bg=colour240] #{S:#{?#{==:#{client_name},#{session_attached_list}},#[fg=colour007#,bold],#[fg=black#,nobold]}#{s/[^0-9]//:session_id}:#{session_name} } #[fg=colour240,bg=colour233]î‚°"
